#!/bin/sh
set -e

CHANGED_KT_FILES="$(git --no-pager diff --name-status --no-color --cached | awk '$1 != "D" && $2 ~ /\.kts|\.kt/ { print $2 }')"

if [ -z "$CHANGED_KT_FILES" ]; then
    echo "No Kotlin staged files. Hence, skipping pre-commit Ktlint run."
    exit 0
fi;

echo "Running Ktlint over these files:"
echo "$CHANGED_KT_FILES"


# -q removes noise from the output if it fails.
# TODO: -w is better, but https://github.com/JLLeitschuh/ktlint-gradle/issues/457 adds noise
# -w should display: "CriticalExceptionTest.kt:19:1 Wildcard import (cannot be auto-corrected)"
# Cleaning and retrying only if the ktlint fails
if ! ./gradlew -q ktlintFormat ; then
    echo "Cleaning the project and retrying."
    # Clean is required because of https://github.com/ankidroid/Anki-Android/issues/9521
    ./gradlew clean
    ./gradlew -q ktlintFormat
fi;

echo "Completed ./gradlew ktlintFormat run."
echo "$CHANGED_KT_FILES" | while read -r file; do
    if [ -f "$file" ]; then
        git add "$file"
    fi
done

CHANGED_JS_FILES="$(git --no-pager diff --name-status --no-color --cached | awk '$1 != "D" && $2 ~ /\.js/ { print $2 }')"

if [ -z "$CHANGED_JS_FILES" ]; then
    echo "No Javascript staged files. Hence, skipping pre-commit Prettier check."
    exit 0
fi;

if ! command -v npx &> /dev/null
then
    echo "npx could not be found, but it is required for pre-commit Prettier check."
    exit 1
fi

echo "Running Prettier check over these files:"
echo "$CHANGED_JS_FILES"

# run Prettier check for all staged files
echo "$CHANGED_JS_FILES" | xargs npx prettier -y --ignore-unknown --check


echo "Completed npx prettier run."
echo "$CHANGED_JS_FILES" | while read -r file; do
    if [ -f "$file" ]; then
        git add "$file"
    fi
done
echo "Completed the pre-commit hook."
